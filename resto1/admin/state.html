<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Fidelavis ‚Äî Dashboard Global</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --brand:#b6152b;
      --bg:#f7f7f7;
      --card:#fff;
      --ink:#1b1b1b;
      --muted:#6b6b6b;
      --line:rgba(0,0,0,.08);
      --r:16px;
      --shadow:0 10px 24px rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--ink);
      padding:14px;
    }
    .wrap{ max-width:1100px; margin:0 auto; }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    h1{ margin:0; font-size:18px; }
    .sub{ color:var(--muted); font-size:12.5px; margin-top:4px; }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:10px;
      box-shadow:var(--shadow);
    }
    select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      color:#222;
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .kpi{ grid-column: span 3; }
    .chart{ grid-column: span 12; }
    .half{ grid-column: span 6; }

    @media (max-width: 860px){
      .kpi{ grid-column: span 6; }
      .half{ grid-column: span 12; }
    }
    @media (max-width: 520px){
      .kpi{ grid-column: span 12; }
    }

    .kpiLabel{ color:var(--muted); font-size:12px; font-weight:800; }
    .kpiValue{ font-size:26px; font-weight:950; margin-top:6px; color:var(--brand); }
    .chartDiv{ width:100%; height:320px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      text-align:left;
    }
    th{ color:#333; font-weight:950; }
    td{ color:#222; font-weight:700; }
    .muted{ color:var(--muted); font-weight:700; }

    .err{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(182,21,43,.18);
      background:rgba(182,21,43,.06);
      color:#7a1120;
      font-weight:800;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>üß† Dashboard Global ‚Äî Fidelavis</h1>
      <div class="sub">Vue r√©seau (tous restos) ‚Äî filtres par p√©riode, resto et type d‚Äô√©v√©nement</div>
    </div>

    <div class="controls">
      <label style="display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#333;">
        P√©riode
        <select id="daysSelect">
          <option value="7">7 jours</option>
          <option value="30" selected>30 jours</option>
          <option value="90">90 jours</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#333;">
        Resto
        <select id="restoSelect">
          <option value="">Tous</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#333;">
        Event
        <select id="eventSelect">
          <option value="">Tous</option>
          <option value="scan">scan</option>
          <option value="signup">signup</option>
          <option value="install">install</option>
          <option value="coupon_validate">coupon_validate</option>
          <option value="review_click">review_click</option>
        </select>
      </label>
    </div>
  </div>

  <div class="grid">
    <div class="card kpi">
      <div class="kpiLabel">Scans</div>
      <div class="kpiValue" id="kScan">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="kpiLabel">Signups</div>
      <div class="kpiValue" id="kSignup">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="kpiLabel">Installs</div>
      <div class="kpiValue" id="kInstall">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="kpiLabel">Coupons valid√©s</div>
      <div class="kpiValue" id="kCoupon">‚Äî</div>
    </div>

    <div class="card chart">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">üìà √âvolution journali√®re</div>
      <div id="chartDaily" class="chartDiv"></div>
      <div id="errBox"></div>
    </div>

    <div class="card half">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">üèÜ Top restos (par event)</div>
      <div class="muted" style="margin-bottom:8px;">Bas√© sur le filtre event (ou tous si ‚ÄúTous‚Äù)</div>
      <table>
        <thead>
          <tr><th>Restaurant</th><th>Count</th></tr>
        </thead>
        <tbody id="topBody"></tbody>
      </table>
    </div>

    <div class="card half">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">ü•ß R√©partition par resto</div>
      <div id="chartPie" class="chartDiv" style="height:320px;"></div>
    </div>
  </div>
</div>

<script>
  const API_TRACK = "https://script.google.com/macros/s/AKfycbxWOMRzGmraEknBpVLzr0dv4FwHiVlZOkcgIMFE39eKj3eqLpUy0PT9zcz9YkxK18cC/exec";

  function groupByDay(rows){
    const map = {};
    rows.forEach(r=>{
      const d = new Date(r.ts);
      if (!isFinite(d.getTime())) return;
      const key = d.toISOString().slice(0,10);
      map[key] = (map[key] || 0) + 1;
    });
    return map;
  }

  function groupByResto(rows){
    const map = {};
    rows.forEach(r=>{
      const k = String(r.resto || "").toLowerCase() || "inconnu";
      map[k] = (map[k] || 0) + 1;
    });
    return map;
  }

  function countEvent(rows, name){
    return rows.filter(r => r.event === name).length;
  }

  async function fetchData(resto, days){
    const url = `${API_TRACK}?resto=${encodeURIComponent(resto || "")}&days=${encodeURIComponent(days || 30)}`;
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  function drawLine(countsByDay){
    const keys = Object.keys(countsByDay).sort();
    const arr = [["Date","Count"]];
    keys.forEach(k => arr.push([k, countsByDay[k]]));

    if (arr.length === 1){
      const today = new Date().toISOString().slice(0,10);
      arr.push([today, 0]);
    }

    const data = google.visualization.arrayToDataTable(arr);
    const chart = new google.visualization.LineChart(document.getElementById("chartDaily"));
    chart.draw(data, {
      title: "√âv√©nements / jour",
      legend: { position:"none" },
      curveType: "function",
      colors: ["#b6152b"],
      chartArea: { left:50, right:20, top:50, bottom:50 },
      hAxis: { textStyle:{ fontSize:11 } },
      vAxis: { minValue:0, textStyle:{ fontSize:11 } }
    });
  }

  function drawPie(countsByResto){
    const arr = [["Restaurant","Count"]];
    Object.entries(countsByResto)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 12)
      .forEach(([k,v]) => arr.push([k, v]));

    if (arr.length === 1){
      arr.push(["aucune donn√©e", 1]);
    }

    const data = google.visualization.arrayToDataTable(arr);
    const chart = new google.visualization.PieChart(document.getElementById("chartPie"));
    chart.draw(data, {
      title: "Top 12 restos",
      chartArea: { left:10, right:10, top:40, bottom:20 }
    });
  }

  function fillTopTable(countsByResto){
    const body = document.getElementById("topBody");
    body.innerHTML = "";
    const entries = Object.entries(countsByResto).sort((a,b)=>b[1]-a[1]).slice(0,10);
    if (!entries.length){
      body.innerHTML = `<tr><td class="muted">Aucune donn√©e</td><td class="muted">0</td></tr>`;
      return;
    }
    entries.forEach(([k,v])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
      body.appendChild(tr);
    });
  }

  function populateRestoSelect(allRows){
    const sel = document.getElementById("restoSelect");
    const current = sel.value;

    const restos = Array.from(new Set(allRows.map(r => String(r.resto||"").toLowerCase()).filter(Boolean)))
      .sort();

    // rebuild only first time or if empty list
    if (sel.options.length <= 1){
      restos.forEach(r=>{
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        sel.appendChild(opt);
      });
    }

    // restore selection if possible
    sel.value = current;
  }

  async function refresh(){
    const errBox = document.getElementById("errBox");
    errBox.innerHTML = "";

    const days = Number(document.getElementById("daysSelect").value || 30);

    // ‚ö†Ô∏è Pour remplir la liste resto, on r√©cup√®re le r√©seau (resto vide)
    let network;
    try{
      network = await fetchData("", days);
    }catch(e){
      errBox.innerHTML = `<div class="err">Erreur fetch r√©seau : ${String(e.message || e)}</div>`;
      return;
    }
    const allRows = Array.isArray(network.rows) ? network.rows : [];
    populateRestoSelect(allRows);

    const resto = document.getElementById("restoSelect").value || "";
    const ev = document.getElementById("eventSelect").value || "";

    // Filtrage local (plus rapide et √©vite multi-calls)
    let rows = allRows;
    if (resto) rows = rows.filter(r => String(r.resto||"").toLowerCase() === resto);
    if (ev) rows = rows.filter(r => r.event === ev);

    // KPI (toujours sur les rows filtr√©s)
    document.getElementById("kScan").textContent   = countEvent(rows, "scan");
    document.getElementById("kSignup").textContent = countEvent(rows, "signup");
    document.getElementById("kInstall").textContent= countEvent(rows, "install");
    document.getElementById("kCoupon").textContent = countEvent(rows, "coupon_validate");

    // Charts / Top
    drawLine(groupByDay(rows));
    const byR = groupByResto(rows);
    fillTopTable(byR);
    drawPie(byR);
  }

  google.charts.load("current", { packages:["corechart"] });
  google.charts.setOnLoadCallback(() => {
    ["daysSelect","restoSelect","eventSelect"].forEach(id=>{
      document.getElementById(id).addEventListener("change", refresh);
    });
    refresh();
  });
</script>
</body>
</html>
