<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Stats Fidelavis</title>

  <style>
    :root{
      --brand:#b6152b;
      --bg:#f9f9f9;
      --card:#fff;
      --ink:#222;
      --muted:#6b6b6b;
      --line:rgba(0,0,0,.10);
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--ink);
      padding:18px 14px 26px;
      max-width:980px;
      margin-inline:auto;
    }
    h1{
      margin:6px 0 14px;
      font-size:20px;
      color:var(--brand);
      letter-spacing:-.2px;
    }
    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow:var(--shadow);
      font-weight:800;
      font-size:13px;
      color:#333;
    }
    .muted{ color:var(--muted); font-weight:700; }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 12;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .kpi{
      grid-column: span 12;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, rgba(182,21,43,.06), rgba(0,0,0,0));
    }
    .kpi .label{ font-size:12px; color:var(--muted); font-weight:800; }
    .kpi .val{ font-size:22px; font-weight:950; margin-top:4px; color:#111; }
    .kpi .sub{ font-size:12px; color:var(--muted); margin-top:4px; font-weight:700; }
    .split{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    select, button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
    }
    button{
      background:var(--brand);
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .err{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(182,21,43,.25);
      background:rgba(182,21,43,.08);
      color:#7b1020;
      font-weight:800;
      font-size:13px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    th{ color:#333; font-weight:950; }
    @media (min-width: 760px){
      .kpi{ grid-column: span 4; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>ðŸ“Š Statistiques Fidelavis</h1>
      <div class="pill">Restaurant : <span id="restoName">...</span> <span class="muted">â€¢</span> PÃ©riode : <span id="periodLabel">30 jours</span></div>
    </div>

    <div class="split">
      <select id="daysSelect">
        <option value="7">7 jours</option>
        <option value="30" selected>30 jours</option>
        <option value="90">90 jours</option>
        <option value="365">365 jours</option>
      </select>
      <button id="reloadBtn">RafraÃ®chir</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="kpiRow">
        <div class="kpi">
          <div class="label">Coupons validÃ©s</div>
          <div class="val" id="k_coupon">â€”</div>
          <div class="sub">event = coupon_validate</div>
        </div>
        <div class="kpi">
          <div class="label">Clics avis Google</div>
          <div class="val" id="k_review">â€”</div>
          <div class="sub">event = review_click</div>
        </div>
        <div class="kpi">
          <div class="label">Clients captÃ©s</div>
          <div class="val" id="k_signup">â€”</div>
          <div class="sub">event = signup (si activÃ©)</div>
        </div>

        <div class="kpi">
          <div class="label">Scans</div>
          <div class="val" id="k_scan">â€”</div>
          <div class="sub">event = scan (si activÃ©)</div>
        </div>
        <div class="kpi">
          <div class="label">Installs</div>
          <div class="val" id="k_install">â€”</div>
          <div class="sub">event = install (si activÃ©)</div>
        </div>
        <div class="kpi">
          <div class="label">Taux dâ€™utilisation coupon</div>
          <div class="val" id="r_coupon">â€”</div>
          <div class="sub">coupon_validate / signup</div>
        </div>

        <div class="kpi">
          <div class="label">Taux dâ€™activation</div>
          <div class="val" id="r_activation">â€”</div>
          <div class="sub">signup / scan</div>
        </div>
        <div class="kpi">
          <div class="label">Taux dâ€™installation</div>
          <div class="val" id="r_install">â€”</div>
          <div class="sub">install / scan</div>
        </div>
      </div>

      <div id="errorBox" class="err" style="display:none;"></div>
    </div>

    <div class="card">
      <div class="split">
        <div style="font-weight:950;">Derniers Ã©vÃ©nements (triÃ©s par date)</div>
        <div class="muted" id="countRows">â€”</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Event</th>
            <th>User</th>
            <th>Page</th>
          </tr>
        </thead>
        <tbody id="rowsTbody">
          <tr><td colspan="4" class="muted">Chargementâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  // âœ… API (global)
  const API = "https://script.google.com/macros/s/AKfycbxWOMRzGmraEknBpVLzr0dv4FwHiVlZOkcgIMFE39eKj3eqLpUy0PT9zcz9YkxK18cC/exec";

  // âœ… dÃ©tecte resto depuis URL: /resto1/admin/state.html
  function getRestoSlug(){
    return location.pathname.replace(/^\/+|\/+$/g,"").split("/")[0] || "voltaire";
  }
  const RESTO = getRestoSlug();
  document.getElementById("restoName").textContent = RESTO;

  function pct(n){
    if (!isFinite(n)) return "â€”";
    return (n*100).toFixed(1).replace(".", ",") + "%";
  }

  function safeDiv(a,b){
    if (!b) return NaN;
    return a / b;
  }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("fr-FR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){
      return String(iso||"");
    }
  }

  async function load(){
    const days = Number(document.getElementById("daysSelect").value || 30);
    document.getElementById("periodLabel").textContent = days + " jours";
    document.getElementById("errorBox").style.display = "none";

    const url = `${API}?resto=${encodeURIComponent(RESTO)}&days=${days}&_=${Date.now()}`;
    try{
      const res = await fetch(url);
      const data = await res.json();

      const rows = Array.isArray(data.rows) ? data.rows : [];

      // Comptage events
      const count = (ev) => rows.filter(r => r.event === ev).length;

      const cCoupon  = count("coupon_validate");
      const cReview  = count("review_click");
      const cSignup  = count("signup");
      const cScan    = count("scan");
      const cInstall = count("install");

      // KPIs
      document.getElementById("k_coupon").textContent  = cCoupon;
      document.getElementById("k_review").textContent  = cReview;
      document.getElementById("k_signup").textContent  = cSignup;
      document.getElementById("k_scan").textContent    = cScan;
      document.getElementById("k_install").textContent = cInstall;

      document.getElementById("r_coupon").textContent      = pct(safeDiv(cCoupon, cSignup));
      document.getElementById("r_activation").textContent  = pct(safeDiv(cSignup, cScan));
      document.getElementById("r_install").textContent     = pct(safeDiv(cInstall, cScan));

      // Table derniers events
      rows.sort((a,b) => new Date(b.ts) - new Date(a.ts));
      document.getElementById("countRows").textContent = rows.length + " events";

      const tb = document.getElementById("rowsTbody");
      tb.innerHTML = "";

      if (!rows.length){
        tb.innerHTML = `<tr><td colspan="4" class="muted">Aucun Ã©vÃ©nement sur la pÃ©riode.</td></tr>`;
        return;
      }

      const max = Math.min(rows.length, 30);
      for (let i=0;i<max;i++){
        const r = rows[i];
        const page = (r.pageURL || "");
        const pageShort = page.length > 44 ? page.slice(0,44) + "â€¦" : page;

        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${fmtDate(r.ts)}</td>
            <td><strong>${r.event || ""}</strong></td>
            <td>${(r.user || "").toString().slice(0,28)}</td>
            <td title="${page.replace(/"/g,"&quot;")}">${pageShort}</td>
          </tr>
        `);
      }

    } catch(err){
      const box = document.getElementById("errorBox");
      box.style.display = "block";
      box.textContent = "Erreur API : " + (err && err.message ? err.message : err);
    }
  }

  document.getElementById("reloadBtn").addEventListener("click", load);
  document.getElementById("daysSelect").addEventListener("change", load);

  load();
</script>
</body>
</html>
