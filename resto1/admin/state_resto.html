<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Fidelavis ‚Äî Dashboard Restaurant</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --brand:#b6152b;
      --bg:#f7f7f7;
      --card:#fff;
      --ink:#1b1b1b;
      --muted:#6b6b6b;
      --line:rgba(0,0,0,.08);
      --r:16px;
      --shadow:0 10px 24px rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--ink);
      padding:14px;
    }
    .wrap{ max-width:1100px; margin:0 auto; }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    h1{ margin:0; font-size:18px; }
    .sub{ color:var(--muted); font-size:12.5px; margin-top:4px; }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:10px;
      box-shadow:var(--shadow);
    }
    select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      color:#222;
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .kpi{ grid-column: span 3; }
    .chart{ grid-column: span 12; }
    .half{ grid-column: span 6; }

    @media (max-width: 860px){
      .kpi{ grid-column: span 6; }
      .half{ grid-column: span 12; }
    }
    @media (max-width: 520px){
      .kpi{ grid-column: span 12; }
    }

    .kpiLabel{ color:var(--muted); font-size:12px; font-weight:800; }
    .kpiValue{ font-size:26px; font-weight:950; margin-top:6px; color:var(--brand); }
    .kpiHint{ margin-top:6px; font-size:12px; color:var(--muted); font-weight:800; }

    .chartDiv{ width:100%; height:320px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      text-align:left;
    }
    th{ color:#333; font-weight:950; }
    td{ color:#222; font-weight:700; }
    .muted{ color:var(--muted); font-weight:700; }

    .err{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(182,21,43,.18);
      background:rgba(182,21,43,.06);
      color:#7a1120;
      font-weight:800;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1 id="title">üìä Dashboard Restaurant ‚Äî Fidelavis</h1>
      <div class="sub" id="subtitle">KPIs & courbes (7/30/90 jours)</div>
    </div>

    <div class="controls">
      <label style="display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#333;">
        P√©riode
        <select id="daysSelect">
          <option value="7">7 jours</option>
          <option value="30" selected>30 jours</option>
          <option value="90">90 jours</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#333;">
        Event
        <select id="eventSelect">
          <option value="">Tous</option>
          <option value="scan">scan</option>
          <option value="signup_open">signup_open</option>
          <option value="scan_to_signup">scan_to_signup</option>
          <option value="signup">signup</option>
          <option value="install">install</option>
          <option value="coupon_validate">coupon_validate</option>
          <option value="review_click">review_click</option>
        </select>
      </label>
    </div>
  </div>

  <div class="grid">
    <div class="card kpi">
      <div class="kpiLabel">Scans</div>
      <div class="kpiValue" id="kScan">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Ouvertures formulaire</div>
      <div class="kpiValue" id="kOpen">‚Äî</div>
      <div class="kpiHint">signup_open</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Scans ‚Üí Formulaire</div>
      <div class="kpiValue" id="kScanToSignup">‚Äî</div>
      <div class="kpiHint">scan_to_signup</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Clients capt√©s</div>
      <div class="kpiValue" id="kSignup">‚Äî</div>
      <div class="kpiHint">Inscrits / activations (signup)</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Installs</div>
      <div class="kpiValue" id="kInstall">‚Äî</div>
      <div class="kpiHint">install</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Coupons valid√©s</div>
      <div class="kpiValue" id="kCoupon">‚Äî</div>
      <div class="kpiHint">coupon_validate</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Clic ‚ÄúDonner mon avis‚Äù</div>
      <div class="kpiValue" id="kReview">‚Äî</div>
      <div class="kpiHint">review_click</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Conv. Scan ‚Üí Inscription</div>
      <div class="kpiValue" id="kConv">‚Äî</div>
      <div class="kpiHint">signup / scan</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Conv. Scan ‚Üí Form</div>
      <div class="kpiValue" id="kConvScanForm">‚Äî</div>
      <div class="kpiHint">scan_to_signup / scan</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Conv. Form ‚Üí Inscription</div>
      <div class="kpiValue" id="kConvFormSignup">‚Äî</div>
      <div class="kpiHint">signup / scan_to_signup</div>
    </div>

    <div class="card kpi">
      <div class="kpiLabel">Conv. Inscription ‚Üí Install</div>
      <div class="kpiValue" id="kConvInstall">‚Äî</div>
      <div class="kpiHint">install / signup</div>
    </div>

    <div class="card chart">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">üìà √âvolution journali√®re</div>
      <div id="chartDaily" class="chartDiv"></div>
      <div id="errBox"></div>
    </div>

    <div class="card half">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">üèÜ Top jours (par volume)</div>
      <div class="muted" style="margin-bottom:8px;">Bas√© sur le filtre event (ou tous si ‚ÄúTous‚Äù)</div>
      <table>
        <thead>
          <tr><th>Date</th><th>Count</th></tr>
        </thead>
        <tbody id="topDaysBody"></tbody>
      </table>
    </div>

    <div class="card half">
      <div style="font-weight:950;color:var(--brand);margin-bottom:8px;">üßæ R√©cap √©v√©nements</div>
      <div class="muted" style="margin-bottom:10px;">Pilotage simple</div>
      <table>
        <tbody id="recapBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const API_TRACK = "https://script.google.com/macros/s/AKfycbxWOMRzGmraEknBpVLzr0dv4FwHiVlZOkcgIMFE39eKj3eqLpUy0PT9zcz9YkxK18cC/exec";

  function getRestoFromUrl(){
    const p = new URLSearchParams(location.search);
    return (p.get("resto") || "").trim().toLowerCase() || "resto1";
  }
  const RESTO = getRestoFromUrl();

  document.getElementById("title").textContent = `üìä Dashboard ‚Äî ${RESTO}`;
  document.getElementById("subtitle").textContent = `KPIs & courbes ‚Äî Restaurant: ${RESTO}`;

  function groupByDay(rows){
    const map = {};
    rows.forEach(r=>{
      const d = new Date(r.ts);
      if (!isFinite(d.getTime())) return;
      const key = d.toISOString().slice(0,10);
      map[key] = (map[key] || 0) + 1;
    });
    return map;
  }

  function countEvent(rows, name){
    return rows.filter(r => r.event === name).length;
  }

  function pct(a,b){
    if (!b) return "‚Äî";
    const p = (a / b) * 100;
    return (Math.round(p * 10) / 10).toFixed(1) + "%";
  }

  async function fetchData(resto, days){
    const url = `${API_TRACK}?resto=${encodeURIComponent(resto || "")}&days=${encodeURIComponent(days || 30)}`;
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  function drawLine(countsByDay){
    const keys = Object.keys(countsByDay).sort();
    const arr = [["Date","Count"]];
    keys.forEach(k => arr.push([k, countsByDay[k]]));

    if (arr.length === 1){
      const today = new Date().toISOString().slice(0,10);
      arr.push([today, 0]);
    }

    const data = google.visualization.arrayToDataTable(arr);
    const chart = new google.visualization.LineChart(document.getElementById("chartDaily"));
    chart.draw(data, {
      title: "√âv√©nements / jour",
      legend: { position:"none" },
      curveType: "function",
      colors: ["#b6152b"],
      chartArea: { left:50, right:20, top:50, bottom:50 },
      hAxis: { textStyle:{ fontSize:11 } },
      vAxis: { minValue:0, textStyle:{ fontSize:11 } }
    });
  }

  function fillTopDays(countsByDay){
    const body = document.getElementById("topDaysBody");
    body.innerHTML = "";

    const entries = Object.entries(countsByDay)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 10);

    if (!entries.length){
      body.innerHTML = `<tr><td class="muted">Aucune donn√©e</td><td class="muted">0</td></tr>`;
      return;
    }

    entries.forEach(([day,count])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${day}</td><td>${count}</td>`;
      body.appendChild(tr);
    });
  }

  function fillRecap(obj){
    const recap = document.getElementById("recapBody");
    recap.innerHTML = `
      <tr><td class="muted">Scans</td><td>${obj.scans}</td></tr>
      <tr><td class="muted">Ouvertures formulaire</td><td>${obj.opens}</td></tr>
      <tr><td class="muted">Scans ‚Üí Formulaire</td><td>${obj.scanTo}</td></tr>
      <tr><td class="muted">Clients capt√©s (signup)</td><td>${obj.signups}</td></tr>
      <tr><td class="muted">Installs</td><td>${obj.installs}</td></tr>
      <tr><td class="muted">Coupons valid√©s</td><td>${obj.coupons}</td></tr>
      <tr><td class="muted">Clic avis</td><td>${obj.reviews}</td></tr>
      <tr><td class="muted">Conv. scan ‚Üí form</td><td>${pct(obj.scanTo, obj.scans)}</td></tr>
      <tr><td class="muted">Conv. form ‚Üí signup</td><td>${pct(obj.signups, obj.scanTo)}</td></tr>
      <tr><td class="muted">Conv. signup ‚Üí install</td><td>${pct(obj.installs, obj.signups)}</td></tr>
      <tr><td class="muted">Conv. signup / scan</td><td>${pct(obj.signups, obj.scans)}</td></tr>
    `;
  }

  async function refresh(){
    const errBox = document.getElementById("errBox");
    errBox.innerHTML = "";

    const days = Number(document.getElementById("daysSelect").value || 30);
    const ev = document.getElementById("eventSelect").value || "";

    let data;
    try{
      data = await fetchData(RESTO, days);
    }catch(e){
      errBox.innerHTML = `<div class="err">Erreur fetch : ${String(e.message || e)}</div>`;
      return;
    }

    let rows = Array.isArray(data.rows) ? data.rows : [];
    rows = rows.filter(r => String(r.resto||"").toLowerCase() === RESTO);

    // KPIs globaux resto
    const scans    = countEvent(rows, "scan");
    const opens    = countEvent(rows, "signup_open");
    const scanTo   = countEvent(rows, "scan_to_signup");
    const signups  = countEvent(rows, "signup");
    const installs = countEvent(rows, "install");
    const coupons  = countEvent(rows, "coupon_validate");
    const reviews  = countEvent(rows, "review_click");

    document.getElementById("kScan").textContent        = scans;
    document.getElementById("kOpen").textContent        = opens;
    document.getElementById("kScanToSignup").textContent= scanTo;
    document.getElementById("kSignup").textContent      = signups;
    document.getElementById("kInstall").textContent     = installs;
    document.getElementById("kCoupon").textContent      = coupons;
    document.getElementById("kReview").textContent      = reviews;

    document.getElementById("kConv").textContent         = pct(signups, scans);
    document.getElementById("kConvScanForm").textContent = pct(scanTo, scans);
    document.getElementById("kConvFormSignup").textContent= pct(signups, scanTo);
    document.getElementById("kConvInstall").textContent  = pct(installs, signups);

    // Charts / tables respectent le filtre event (optionnel)
    const filteredRows = ev ? rows.filter(r => r.event === ev) : rows;
    const byDay = groupByDay(filteredRows);
    drawLine(byDay);
    fillTopDays(byDay);

    fillRecap({ scans, opens, scanTo, signups, installs, coupons, reviews });
  }

  google.charts.load("current", { packages:["corechart"] });
  google.charts.setOnLoadCallback(() => {
    ["daysSelect","eventSelect"].forEach(id=>{
      document.getElementById(id).addEventListener("change", refresh);
    });
    refresh();
  });
</script>
</body>
</html>
