<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Activer -10% ‚Äî Fidelavis</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#B8924F;
      --line:rgba(0,0,0,.08);
      --shadow:0 16px 34px rgba(0,0,0,.10);
      --radius:18px;
      --bg1:#f7f0e8;
      --bg2:#f4eadf;
      --ok:#1f8a4c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%);
      color:#1d1d1d;
      padding:10px 12px calc(70px + env(safe-area-inset-bottom));
      text-align:center;
    }
    .wrap{max-width:460px;margin:0 auto;}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 12px;border-radius:999px;
      background:#fff;border:1px solid var(--line);
      font-weight:900;font-size:12px;
      margin:0 0 6px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok)}
    h1{
      margin:0 0 6px;
      font-size:22px;
      line-height:1.10;
      font-weight:950;
      letter-spacing:-0.35px;
    }
    .micro{
      margin:0 0 10px;
      font-size:13px;
      font-weight:900;
      color:#2b2b2b;
      opacity:.88;
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px;
      text-align:left;
    }
    iframe{
      width:100%;
      border:0;
      border-radius:14px;
      background:#fff;
      display:block;
      height:560px;
    }

    .sticky{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(247,240,232,0) 0%, rgba(247,240,232,.92) 30%, rgba(247,240,232,.98) 100%);
      backdrop-filter: blur(10px);
      z-index:999;
    }
    .stickyInner{
      max-width:460px;
      margin:0 auto;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    .btnLink{
      flex:1 1 0;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;font-size:13px;
      color:#2b2b2b;
      text-decoration:none;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="badge"><span class="dot"></span>Derni√®re √©tape</div>
    <h1>üéÅO√π devons-nous envoyer votre -10% ?</h1>
    <p class="micro">‚ö° 10 secondes ‚Ä¢ üéÅ Gratuit ‚Ä¢ üîí Anti-spam</p>

    <div class="card" id="card">
      <iframe
        id="ghlFrame"
        src="https://api.leadconnectorhq.com/widget/form/MAbxQNqssstYs2a4VbuI"
        title="Formulaire d'inscription"></iframe>
    </div>
  </div>

  <div class="sticky">
    <div class="stickyInner">
      <a class="btnLink" id="ppBtn" href="/privacy.html">üîêConfidentialit√©</a>
      <a class="btnLink" id="cguBtn" href="/cgu.html">üìÑ CGU</a>
    </div>
  </div>

<script>
(function(){
  // Liens retour corrects (restoX)
  const from = encodeURIComponent(location.pathname);
  document.getElementById("ppBtn").href  = "/privacy.html?from=" + from;
  document.getElementById("cguBtn").href = "/cgu.html?from=" + from;

  // Hauteur iframe = hauteur √©cran - (header + marges + footer sticky)
  function setFrameHeight(){
    const frame = document.getElementById("ghlFrame");
    const card  = document.getElementById("card");
    const sticky = document.querySelector(".sticky");

    const vh = window.innerHeight;
    const top = card.getBoundingClientRect().top;
    const stickyH = sticky.getBoundingClientRect().height;

    const safety = 8;
    const available = Math.max(420, Math.floor(vh - top - stickyH - safety));
    frame.style.height = available + "px";
  }

  window.addEventListener("resize", setFrameHeight);
  window.addEventListener("orientationchange", setFrameHeight);
  setTimeout(setFrameHeight, 60);
  setTimeout(setFrameHeight, 240);
})();
</script>

<!-- ‚úÖ PATCH TRACKING (GLOBAL SHEET) -->
<script>
/* ============================
   RESTO SLUG
============================ */
function getRestoSlug() {
  return location.pathname.replace(/^\/+|\/+$/g, "").split("/")[0] || "voltaire";
}
const RESTO = getRestoSlug();

/* ============================
   API TRACKING
============================ */
const API_TRACK = "https://script.google.com/macros/s/AKfycbxWOMRzGmraEknBpVLzr0dv4FwHiVlZOkcgIMFE39eKj3eqLpUy0PT9zcz9YkxK18cC/exec";

function track(eventName, extra = {}) {
  const now = new Date();
  const payload = {
    resto: RESTO,
    event: eventName,
    mois: now.getMonth() + 1,
    annee: now.getFullYear(),
    user: (localStorage.getItem("user_email") || ""),
    userAgent: navigator.userAgent,
    pageURL: location.href,
    ...extra
  };

  fetch(API_TRACK, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  }).catch(()=>{});
}

/* ============================
   1) Event "scan_to_signup" (optionnel, mais utile)
============================ */
(function(){
  const key = `scan_to_signup_${RESTO}_${new Date().toISOString().slice(0,10)}`;
  if (!sessionStorage.getItem(key)) {
    sessionStorage.setItem(key, "1");
    track("scan_to_signup");
  }
})();

/* ============================
   2) Event "signup" si confirm√© par redirect ?submitted=1
   ‚ûú tu r√®gles GHL pour rediriger vers: /resto1/coupon.html?submitted=1
============================ */
(function(){
  const params = new URLSearchParams(location.search);
  const submitted = params.get("submitted");

  if (submitted === "1") {
    const dedupKey = `signup_${RESTO}`;
    const last = Number(localStorage.getItem(dedupKey) || "0");
    const now = Date.now();

    // Anti-doublon 24h
    if (!last || (now - last) > (24 * 60 * 60 * 1000)) {
      localStorage.setItem(dedupKey, String(now));
      track("signup", { source: "ghl_redirect_submitted" });
    }
  }
})();
</script>

</body>
</html>
