<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Coupon du Mois ‚Äì Fidelavis</title>

  <!-- üîê BOOTSTRAP EMAIL + COOKIE FALLBACK (coupon = home PWA) -->
  <script>
  (function () {
    function currentFolderBase(){
      const p = window.location.pathname;
      return p.slice(0, p.lastIndexOf("/") + 1);
    }

    window.goLocal = function(page){
      const base = currentFolderBase();
      const url = new URL(base + page, window.location.origin);

      const params = new URLSearchParams(window.location.search);
      params.delete("email");
      params.forEach((v,k)=>url.searchParams.set(k,v));

      window.location.href = url.toString();
    };

    function setCookie(name, value, days){
      const maxAge = days * 24 * 60 * 60;
      document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
    }
    function getCookie(name){
      const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return m ? decodeURIComponent(m[2]) : "";
    }
    function restoreEmailFromCookie(){
      const localEmail = (localStorage.getItem("user_email") || "").trim().toLowerCase();
      if (localEmail) return localEmail;

      const c = (getCookie("user_email") || "").trim().toLowerCase();
      if (c) {
        localStorage.setItem("user_email", c);
        localStorage.setItem("is_registered", "1");
        return c;
      }
      return "";
    }

    const params = new URLSearchParams(window.location.search);
    const emailRaw = params.get("email") || "";

    let email = "";
    try { email = decodeURIComponent(emailRaw).trim().toLowerCase(); }
    catch(e){ email = (emailRaw || "").trim().toLowerCase(); }

    const emailOk = /^[^\s@]+@[^\s@]+\.[A-Za-z]{2,}$/.test(email);

    if (emailOk) {
      localStorage.setItem("user_email", email);
      localStorage.setItem("is_registered", "1");
      setCookie("user_email", email, 365);
      setCookie("is_registered", "1", 365);

      params.delete("email");
      const clean = window.location.pathname + (params.toString() ? "?" + params.toString() : "");
      try { history.replaceState({}, document.title, clean); } catch(e) {}
      setTimeout(() => { try { history.replaceState({}, document.title, clean); } catch(e) {} }, 250);
    } else {
      restoreEmailFromCookie();
    }

    function hasEmail(){
      return (restoreEmailFromCookie().trim().length > 0);
    }

    if (hasEmail()) return;

    setTimeout(() => {
      if (!hasEmail()) window.goLocal("inscription.html");
    }, 450);
  })();
  </script>

  <style>
    :root{
      --brand:#B48C4A;
      --bg:#fbfaf8;
      --card:#ffffff;
      --ink:#191919;
      --muted:#6f6f6f;
      --line:rgba(0,0,0,.08);
      --shadow:0 18px 50px rgba(0,0,0,.08);
      --r:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 520px at 50% -160px, rgba(180,140,74,0.16), transparent 60%),
        linear-gradient(180deg, #fbfaf8 0%, #f6f2ec 100%);
      color:var(--ink);
      padding:24px 14px 30px;
      text-align:center;
    }

    .wrap{ max-width:520px; margin:0 auto; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.75);
      border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(0,0,0,.05);
      font-weight:900;
      font-size:13px;
      color:#3b3b3b;
      margin-bottom:10px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:#1f8a4c;
      box-shadow:0 0 0 6px rgba(31,138,76,.12);
    }

    h1{
      margin:10px 0 6px;
      font-size:28px;
      letter-spacing:-0.4px;
      font-weight:950;
      color:#1a1a1a;
    }
    .sub{
      margin:0 auto 18px;
      max-width:420px;
      font-size:14px;
      color:var(--muted);
      line-height:1.35;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:18px 16px 16px;
      box-shadow:var(--shadow);
      text-align:left;
    }

    .offer{
      border-radius:18px;
      padding:14px 14px;
      border:1px solid rgba(180,140,74,.22);
      background:linear-gradient(180deg, rgba(180,140,74,.12) 0%, rgba(180,140,74,.06) 100%);
      margin-bottom:14px;
    }
    .offerTitle{
      margin:0 0 6px;
      font-weight:950;
      color:#4a3a18;
      font-size:13px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .offerText{
      margin:0;
      font-size:16px;
      font-weight:900;
      color:#241b0b;
      line-height:1.2;
    }

    .pinLabel{
      margin:10px 0 10px;
      color:#2a2a2a;
      font-weight:900;
      font-size:13px;
      text-align:left;
    }
    .pinGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin:0 0 6px;
    }
    .pinBox{
      width:100%;
      height:64px;
      border-radius:16px;
      border:2px solid rgba(180,140,74,.45);
      background:#fff;
      font-size:26px;
      font-weight:950;
      text-align:center;
      outline:none;
      box-shadow:0 10px 22px rgba(180,140,74,.06);
    }
    .pinBox:focus{
      border-color: rgba(180,140,74,.85);
      box-shadow:0 14px 26px rgba(180,140,74,.14);
    }
    .pinBox::-webkit-outer-spin-button,
    .pinBox::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    .btn{
      width:100%;
      margin-top:12px;
      padding:16px 16px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-weight:950;
      font-size:16px;
    }
    .btnPrimary{
      background:linear-gradient(180deg, var(--brand) 0%, #a97f37 100%);
      color:#fff;
      box-shadow:0 16px 30px rgba(180,140,74,.22);
    }
    .btnSecondary{
      background:#fff;
      color:var(--brand);
      border:2px solid rgba(180,140,74,.55);
      margin-top:10px;
    }

    .result{ margin-top:12px; }
    .ok-box{
      padding:14px;
      border-radius:14px;
      font-weight:950;
      font-size:16px;
      text-align:center;
      border:1px solid var(--line);
    }
    .success { background:#d4edda;color:#155724; border-color: rgba(21,87,36,.18); }
    .error { background:#f8d7da;color:#721c24; border-color: rgba(114,28,36,.18); }
    .warn { background:#fff3cd;color:#856404; border-color: rgba(133,100,4,.18); }

    small{
      display:block;
      margin-top:12px;
      color:#8a8a8a;
      font-size:12px;
      text-align:center;
      line-height:1.3;
    }

    .reviewBox{
      margin-top:14px;
      padding:16px;
      border-radius:16px;
      background:rgba(180,140,74,.08);
      border:1px solid rgba(180,140,74,.18);
      text-align:center;
      animation:fadeIn .4s ease;
    }
    .reviewTitle{ margin:0 0 8px; font-weight:950; color:#2a2a2a; }
    .reviewSub{ margin:0 0 12px; font-size:13px; color:#6f6f6f; line-height:1.35; }
    .reviewLink{
      display:block;
      margin-top:10px;
      font-size:12.5px;
      color:#8a8a8a;
      text-decoration:underline;
      cursor:pointer;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(6px);}
      to{opacity:1; transform:translateY(0);}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="badge"><span class="dot"></span>Acc√®s client activ√©</div>
  <h1>Coupon du mois</h1>
  <p class="sub">Pr√©sentez ce coupon en caisse. Entrez le code PIN affich√© par le restaurant.</p>

  <div class="card">
    <div class="offer">
      <p class="offerTitle">OFFRE EN COURS</p>
      <p class="offerText" id="txtOffer">Chargement‚Ä¶</p>
    </div>

    <div class="pinLabel">Code PIN (4 chiffres)</div>

    <div class="pinGrid" id="pinGrid" aria-label="Code PIN 4 chiffres">
      <input class="pinBox" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="one-time-code" aria-label="Chiffre 1">
      <input class="pinBox" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Chiffre 2">
      <input class="pinBox" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Chiffre 3">
      <input class="pinBox" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Chiffre 4">
    </div>

    <button class="btn btnPrimary" type="button" onclick="soumettrePin()">Valider le coupon</button>
    <button class="btn btnSecondary" type="button" onclick="partager()">Partager ce restaurant</button>

    <div id="result" class="result"></div>

    <small>Valable une fois par mois ‚Äì R√©initialisation automatique chaque 1er.</small>
  </div>

  <audio id="audioOK">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3">
  </audio>

</div>

<script>
/* ============================
   PIN UX (auto-avance, backspace, collage)
============================ */
(function pinUX(){
  const grid = document.getElementById("pinGrid");
  if (!grid) return;

  const boxes = Array.from(grid.querySelectorAll(".pinBox"));
  function sanitizeDigit(v){ return (v || "").replace(/\D/g, "").slice(0,1); }

  setTimeout(()=> boxes[0]?.focus(), 250);

  boxes.forEach((box, idx) => {
    box.addEventListener("input", () => {
      const d = sanitizeDigit(box.value);
      box.value = d;
      if (d && idx < boxes.length - 1) boxes[idx + 1].focus();
    });

    box.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !box.value && idx > 0) {
        boxes[idx - 1].focus();
        boxes[idx - 1].value = "";
        e.preventDefault();
      }
      if (e.key === "Enter") soumettrePin();
    });

    box.addEventListener("paste", (e) => {
      const txt = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = txt.replace(/\D/g, "").slice(0, 4).split("");
      if (!digits.length) return;

      e.preventDefault();
      const start = idx;
      for (let i = 0; i < digits.length && (start + i) < boxes.length; i++){
        boxes[start + i].value = digits[i];
      }
      const nextIndex = Math.min(start + digits.length, boxes.length - 1);
      boxes[nextIndex].focus();
    });
  });

  window.getPinCode = function(){
    return boxes.map(b => (b.value || "")).join("");
  };
})();
</script>

<script>
/* ============================
   CONTEXTE RESTAURANT
============================ */
function getRestoSlug() {
  return location.pathname.replace(/^\/+|\/+$/g, "").split("/")[0] || "voltaire";
}
const RESTO = getRestoSlug();

/* ============================
   API TRACKING (GLOBAL SHEET)
============================ */
const API_TRACK = "https://script.google.com/macros/s/AKfycbxWOMRzGmraEknBpVLzr0dv4FwHiVlZOkcgIMFE39eKj3eqLpUy0PT9zcz9YkxK18cC/exec";

/* ============================
   OFFRE MENSUELLE
============================ */
const offers = [
  "üéÅ Janvier : -10% menu","üéÅ F√©vrier : Dessert offert","üéÅ Mars : Caf√© offert",
  "üéÅ Avril : -15% v√©g√©tarien","üéÅ Mai : Ap√©ritif offert","üéÅ Juin : Entr√©e offerte",
  "üéÅ Juillet : Glace enfant","üéÅ Ao√ªt : Boisson gratuite","üéÅ Septembre : -20% √©tudiants",
  "üéÅ Octobre : Caf√© gourmand","üéÅ Novembre : Menu duo","üéÅ D√©cembre : Chocolat chaud"
];

const now = new Date();
const MONTH = now.getMonth();
const YEAR = now.getFullYear();
document.getElementById("txtOffer").textContent = offers[MONTH];

// 1er du mois => reset
const COUPON_KEY = `coupon_${RESTO}_${YEAR}_${MONTH}`;
if (now.getDate() === 1) localStorage.removeItem(COUPON_KEY);

// ‚úÖ Avis: anti-spam (par resto + par mois)
const REVIEW_KEY = `review_${RESTO}_${YEAR}_${MONTH}`;

/* ============================
   TRACK HELPER (PATCH ‚úÖ sendBeacon + keepalive)
============================ */
function track(eventName, extra = {}) {
  const payload = {
    resto: RESTO,
    event: eventName,
    mois: MONTH + 1,
    annee: YEAR,
    user: (localStorage.getItem("user_email") || ""),
    userAgent: navigator.userAgent,
    pageURL: location.href,
    ...extra
  };

  const body = JSON.stringify(payload);

  // ‚úÖ Best: sendBeacon (survit aux redirections)
  if (navigator.sendBeacon) {
    try {
      const blob = new Blob([body], { type: "text/plain;charset=utf-8" });
      navigator.sendBeacon(API_TRACK, blob);
      return;
    } catch(e) {}
  }

  // ‚úÖ Fallback: fetch keepalive
  fetch(API_TRACK, {
    method: "POST",
    mode: "no-cors",
    keepalive: true,
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body
  }).catch(()=>{});
}

/* ============================
   ‚úÖ Aller vers la page avis (m√™me dossier) (PATCH d√©lai)
============================ */
function allerAvis(){
  localStorage.setItem(REVIEW_KEY, "done"); // anti-spam
  track("review_click");

  // ‚úÖ mini d√©lai pour laisser le beacon partir
  setTimeout(() => {
    if (typeof window.goLocal === "function") window.goLocal("avis.html");
    else window.location.href = "avis.html";
  }, 120);
}

// ‚úÖ "Plus tard" => ne repropose plus ce mois-ci
function fermerAvis(){
  localStorage.setItem(REVIEW_KEY, "later");
  const el = document.getElementById("reviewPrompt");
  if (el) el.remove();
}

/* ============================
   üîê PIN SYNCHRONIS√â ADMIN
============================ */
const SECRET_KEY = "OFFLINE123";
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) % 1000000007;
  return h;
}
function getMinute(offset = 0) { return Math.floor(Date.now() / 60000) + offset; }
function generatePin(offset = 0) {
  return (simpleHash(SECRET_KEY + getMinute(offset)) % 10000).toString().padStart(4, "0");
}
function verifierPin(pin) { return [-2, -1, 0, 1, 2].some(o => generatePin(o) === pin); }

/* ============================
   VALIDATION COUPON
============================ */
function soumettrePin() {
  const res = document.getElementById("result");
  const code = (window.getPinCode ? window.getPinCode() : "").trim();

  // Nettoie un ancien bloc avis si pr√©sent (√©vite doublons)
  const old = document.getElementById("reviewPrompt");
  if (old) old.remove();

  if (localStorage.getItem(COUPON_KEY) === "used") {
    res.innerHTML = `<div class="ok-box error">‚ùå Coupon d√©j√† utilis√©</div>`;
    return;
  }

  if (!/^\d{4}$/.test(code)) {
    res.innerHTML = `<div class="ok-box warn">‚ö†Ô∏è Code invalide</div>`;
    return;
  }

  if (verifierPin(code)) {
    localStorage.setItem(COUPON_KEY, "used");
    res.innerHTML = `<div class="ok-box success">‚úÖ Coupon valid√©</div>`;
    document.getElementById("audioOK").play().catch(()=>{});

    // ‚úÖ TRACK: validation coupon
    track("coupon_validate");

    // ‚úÖ Avis uniquement apr√®s validation + uniquement si pas d√©j√† fait/ferm√© ce mois-ci
    setTimeout(() => {
      if (localStorage.getItem(REVIEW_KEY)) return;

      const box = document.createElement("div");
      box.className = "reviewBox";
      box.id = "reviewPrompt";
      box.innerHTML = `
        <p class="reviewTitle">Votre avis compte</p>
        <p class="reviewSub">Si vous le souhaitez, vous pouvez partager votre exp√©rience.</p>
        <button class="btn btnSecondary" type="button" onclick="allerAvis()">Donner mon avis</button>
        <span class="reviewLink" onclick="fermerAvis()">Plus tard</span>
      `;
      res.appendChild(box);
    }, 1000);

  } else {
    res.innerHTML = `<div class="ok-box error">‚ùå Code incorrect</div>`;
  }
}

/* ============================
   üîó PARTAGE PWA
============================ */
function partager() {
  const shareUrl = "https://bit.ly/4psvq0G";
  const data = {
    title: "D√©couvre ce restaurant",
    text: "Je te recommande ce restaurant. Il y a des offres exclusives via Fidelavis üëá",
    url: shareUrl
  };

  if (navigator.share) {
    navigator.share(data).catch(() => {});
  } else if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(shareUrl).then(() => alert("Lien copi√© üëç")).catch(()=>alert("Copiez ce lien : " + shareUrl));
  } else {
    alert("Copiez ce lien : " + shareUrl);
  }
}

/* √âtat d√©j√† utilis√© */
if (localStorage.getItem(COUPON_KEY) === "used") {
  document.getElementById("result").innerHTML =
    `<div class="ok-box error">‚ùå Coupon d√©j√† utilis√©</div>`;
}
</script>

</body>
</html>
