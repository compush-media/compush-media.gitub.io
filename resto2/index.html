<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Programme Fid√©lit√©</title>

<!-- ‚úÖ Email: on le stocke si pr√©sent, mais on NE BLOQUE PAS l‚Äôacc√®s √† l‚Äôindex -->
<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const email = params.get('email');

  if (email) {
    localStorage.setItem('user_email', email);
    // Nettoie l‚ÄôURL (retire ?email=)
    const cleanUrl = window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }
})();
</script>

<style>
:root{
  --brand:#C6A667;
  --bg:#fff8f2;
  --text:#C6A667;
  --shadow: 0 18px 46px rgba(0,0,0,.10);
  --shadow2: 0 10px 26px rgba(0,0,0,.08);
  --radius: 22px;

  --card:#ffffff;
  --muted: rgba(0,0,0,.55);
}

body{
  margin:0;
  font-family:'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(900px 520px at 50% 0%, #ffffff 0%, var(--bg) 60%, #efe7db 100%);
  color: var(--text);
  text-align:center;
}

/* HEADER */
.header{ margin-top: 46px; }
.header img{
  max-width: 110px;
  filter: drop-shadow(0 6px 16px rgba(0,0,0,.08));
}
.header h1{
  font-size: 22px;
  margin: 12px 0 6px;
  letter-spacing:.2px;
}
.header .sub{
  font-size: 13px;
  opacity: .55;
  font-weight: 600;
  margin: 0;
}

/* Container */
.navbar{
  display:flex;
  flex-direction:column;
  gap: 18px;
  padding: 34px 18px 10px;
  max-width: 520px;
  margin: 0 auto;
}

/* BUTTON BASE */
.navbar a{
  width:100%;
  text-decoration:none;
  border-radius: var(--radius);
  padding: 24px 18px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:row;
  gap: 14px;
  position:relative;
  user-select:none;
  text-align:left;
  transition: transform .10s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
}
.navbar a:active{ transform: translateY(1px) scale(.995); }

/* ICON BLOCK */
.ico{
  width: 46px;
  height: 46px;
  border-radius: 14px;
  display:grid;
  place-items:center;
  flex:0 0 auto;
  background: rgba(255,255,255,.16);
  border: 1px solid rgba(255,255,255,.22);
}
.navbar a.secondary .ico{
  background: rgba(198,166,103,.10);
  border: 1px solid rgba(198,166,103,.22);
}
.ico svg{
  width: 26px;
  height: 26px;
  fill: currentColor;
  opacity: .95;
}

/* TEXT BLOCK */
.txt{
  display:flex;
  flex-direction:column;
  gap:4px;
  flex:1 1 auto;
  min-width:0;
}
.btn-title{
  font-weight: 900;
  font-size: clamp(15px, 4.5vw, 18px);
  white-space: nowrap;
  line-height: 1.15;
}
.btn-sub{
  font-size: 12.5px;
  font-weight: 600;
  opacity: .88;
  line-height: 1.2;
}

/* RIGHT PILL */
.pill{
  flex:0 0 auto;
  font-size: 12px;
  font-weight: 900;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.28);
  background: rgba(255,255,255,.16);
}
.navbar a.secondary .pill{
  border: 1px solid rgba(198,166,103,.28);
  background: rgba(198,166,103,.10);
}

/* PRIMARY CTA */
.navbar a.primary{
  background: linear-gradient(180deg, color-mix(in srgb, var(--brand) 95%, #fff) 0%, var(--brand) 100%);
  color: #ffffff;
  border: 2px solid color-mix(in srgb, var(--brand) 92%, #000);
  box-shadow: var(--shadow);
}
.navbar a.primary:hover{
  box-shadow: 0 22px 60px rgba(0,0,0,.13);
  transform: translateY(-2px);
}

/* ‚úÖ RIBBON (OFFRE DU MOIS) */
.ribbon{
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:34px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  font-weight:900;
  letter-spacing:.4px;
  background: rgba(0,0,0,.16);
  color:#ffffff;
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
}
/* space for ribbon on primary button */
.navbar a.primary{ padding-top:60px; }

/* SECONDARY */
.navbar a.secondary{
  background: rgba(255,255,255,.82);
  color: var(--brand);
  border: 2px solid color-mix(in srgb, var(--brand) 75%, #0000);
  box-shadow: var(--shadow2);
}
.navbar a.secondary:hover{
  background: rgba(198,166,103,.06);
  transform: translateY(-2px);
  box-shadow: 0 16px 40px rgba(0,0,0,.10);
}

/* Trust + Legal */
.trust{
  max-width: 520px;
  margin: 10px auto 0;
  padding: 0 18px;
  font-size: 12px;
  opacity: .65;
  font-weight: 600;
}
.legal{
  max-width: 520px;
  margin: 14px auto 40px;
  padding: 0 18px;
  font-size: 11px;
  opacity: .55;
  line-height: 1.35;
}

/* ===========================
   ‚úÖ OVERLAY INSTALL (INLINE)
   =========================== */
.overlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.46);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:9999;
  padding: 14px;
}
.sheet{
  width:min(560px, 100%);
  background: var(--card);
  border-radius: 22px;
  box-shadow: 0 24px 70px rgba(0,0,0,.25);
  overflow:hidden;
  border: 1px solid rgba(0,0,0,.06);
}
.sheetTop{
  padding: 16px 18px 12px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.sheetTitle{
  text-align:left;
}
.sheetTitle h2{
  margin:0;
  font-size: 18px;
  color: #111;
  letter-spacing:.1px;
}
.sheetTitle p{
  margin:6px 0 0;
  font-size: 13px;
  color: rgba(0,0,0,.58);
  line-height: 1.25;
  font-weight: 600;
}
.closeBtn{
  border:0;
  background: rgba(0,0,0,.06);
  color:#111;
  width: 38px;
  height: 38px;
  border-radius: 12px;
  font-size: 18px;
  cursor:pointer;
}

.sheetBody{
  padding: 0 18px 16px;
}
.notice{
  border: 2px solid color-mix(in srgb, var(--brand) 40%, #0000);
  background: color-mix(in srgb, var(--brand) 10%, #fff);
  border-radius: 16px;
  padding: 12px 12px;
  text-align:left;
  color:#111;
}
.notice b{ color:#111; }
.notice .small{
  margin-top:6px;
  font-size: 12.5px;
  color: rgba(0,0,0,.62);
  font-weight: 600;
}

.actions{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top: 14px;
}
.btn{
  border:0;
  width:100%;
  border-radius: 16px;
  padding: 14px 14px;
  font-weight: 900;
  font-size: 15px;
  cursor:pointer;
}
.btnPrimary{
  background: linear-gradient(180deg, color-mix(in srgb, var(--brand) 95%, #fff) 0%, var(--brand) 100%);
  color:#fff;
  box-shadow: 0 14px 40px rgba(0,0,0,.14);
}
.btnGhost{
  background: rgba(0,0,0,.06);
  color:#111;
}
.helper{
  margin-top: 12px;
  font-size: 12px;
  color: rgba(0,0,0,.55);
  text-align:left;
  line-height: 1.35;
  font-weight: 600;
}
.helper code{
  background: rgba(0,0,0,.06);
  padding: 2px 6px;
  border-radius: 8px;
}
.badgeRow{
  display:flex;
  gap:8px;
  margin-top: 10px;
  flex-wrap:wrap;
}
.badge{
  font-size: 12px;
  font-weight: 900;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(0,0,0,.06);
  color:#111;
}

@media (max-width:480px){
  .navbar{ padding: 28px 14px 8px; gap: 16px; }
  .navbar a{ padding: 22px 14px; border-radius: 20px; gap: 12px; }
  .navbar a.primary{ padding-top:56px; }
  .btn-sub{ font-size: 12px; }
  .ico{ width: 42px; height: 42px; border-radius: 13px; }
  .pill{ font-size: 11.5px; padding: 7px 9px; }
  .ribbon{ height:32px; font-size:12.5px; }
  .overlay{ align-items:flex-end; }
}
</style>
</head>

<body>

<div class="header">
  <img src="https://storage.googleapis.com/msgsndr/jpliF4UmGdEH0PBGE1Um/media/693872ebdaae41354591b36f.png" alt="Logo" />
  <h1 id="restoName">Restaurant</h1>
  <p class="sub">2 actions simples : avantage + avis</p>
</div>

<div class="navbar">
  <a id="btnCoupon" class="primary" aria-label="Activer -10% prochaine visite"></a>
  <a id="btnAvis" class="secondary" aria-label="Laisser un avis"></a>
</div>

<div class="trust">‚úÖ Simple ‚Ä¢ ‚úÖ Rapide ‚Ä¢ ‚úÖ Sans engagement</div>

<div class="legal">
  La r√©duction est ind√©pendante de tout avis. Laisser un avis est totalement facultatif et n‚Äôinfluence pas l‚Äôavantage propos√©.
</div>

<!-- ‚úÖ OVERLAY INSTALL (1 SEUL √âCRAN) -->
<div class="overlay" id="installOverlay" role="dialog" aria-modal="true" aria-label="Installer l‚Äôapplication">
  <div class="sheet">
    <div class="sheetTop">
      <div class="sheetTitle">
        <h2>üîí Activer votre r√©duction en caisse</h2>
        <p>Pour √©viter les captures d‚Äô√©cran, l‚Äôacc√®s au coupon se fait via l‚Äôapplication (PWA).</p>
      </div>
      <button class="closeBtn" id="closeOverlay" aria-label="Fermer">‚úï</button>
    </div>

    <div class="sheetBody">
      <div class="notice">
        <b>üéÅ -10% OFFERT</b> ‚Äî activation en <b>10 secondes</b>.
        <div class="small">Ensuite, vous pourrez vous inscrire et recevoir votre r√©duction par email.</div>

        <div class="badgeRow">
          <div class="badge">‚úÖ 10 secondes</div>
          <div class="badge">‚úÖ Sans compte</div>
          <div class="badge">‚úÖ Sans engagement</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btnPrimary" id="btnInstallNow">Installer maintenant</button>
        <button class="btn btnGhost" id="btnContinueAnyway">Continuer vers l‚Äôinscription</button>
      </div>

      <div class="helper" id="iosHelp" style="display:none;">
        <b>iPhone :</b> appuyez sur <code>Partager</code> (‚¨ÜÔ∏é) puis <code>Ajouter √† l‚Äô√©cran d‚Äôaccueil</code>.
      </div>

      <div class="helper" style="margin-top:10px;">
        <span style="opacity:.8;">Astuce :</span> une fois install√©e, vous la retrouvez sur votre √©cran d‚Äôaccueil.
      </div>
    </div>
  </div>
</div>

<script>
/* ===========
   RESTO SLUG
   =========== */
function getRestoSlug(){
  const path = window.location.pathname.replace(/^\/+|\/+$/g, "");
  return path.split("/")[0] || "voltaire";
}
const restoSlug = getRestoSlug();

/* ===========
   PWA CHECKS
   =========== */
function isStandalone(){
  return window.matchMedia('(display-mode: standalone)').matches
      || window.navigator.standalone === true; // iOS Safari
}
function isIOS(){
  return /iphone|ipad|ipod/i.test(navigator.userAgent);
}

/* ===========
   THEME DATA
   =========== */
const restaurantData = {
  voltaire: { name:"Resto1", brandColor:"#B48C4A", bgColor:"#ffffff", textColor:"#B48C4A" },
  resto3:   { name:"Resto 3", brandColor:"#C6A667", bgColor:"#fff8f2", textColor:"#C6A667" }
};
const resto = restaurantData[restoSlug] || restaurantData.voltaire;

document.documentElement.style.setProperty('--brand', resto.brandColor);
document.documentElement.style.setProperty('--bg', resto.bgColor);
document.documentElement.style.setProperty('--text', resto.textColor);
document.getElementById("restoName").innerText = resto.name;

/* ===========
   BUTTON HTML
   =========== */
const icons = {
  btnCoupon: `
    <div class="ribbon">üî• Offre du mois</div>

    <div class="ico" aria-hidden="true">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor"
          d="M21 5v3.5q-.625.275-1.063.713T19.225 10
             q0 .825.437 1.263T21 12.025V15
             q0 .825-.588 1.413T19 17H5
             q-.825 0-1.413-.588T3 15v-3
             q.625-.275 1.063-.713T4.775 10
             q0-.825-.437-1.263T3 7.525V5
             q0-.825.588-1.413T5 3h14
             q.825 0 1.413.588T21 5Z"/>
      </svg>
    </div>

    <div class="txt">
      <div class="btn-title">üéÅ -10% OFFERT (prochaine visite)</div>
      <div class="btn-sub">Re√ßu imm√©diatement par email ‚Ä¢ √† utiliser lors de votre prochain passage</div>
    </div>

    <div class="pill">10s</div>
  `,
  btnAvis: `
    <div class="ico" aria-hidden="true">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor"
          d="M12 17.3l6.2 3.7-1.6-7
             5.4-4.7-7.2-.6L12 2
             9.2 8.7l-7.2.6
             5.4 4.7-1.6 7z"/>
      </svg>
    </div>

    <div class="txt">
      <div class="btn-title">‚≠ê Laisser un avis (facultatif)</div>
      <div class="btn-sub">1 minute ‚Ä¢ √áa aide √©norm√©ment le restaurant</div>
    </div>

    <div class="pill">1 min</div>
  `
};

const btnCoupon = document.getElementById("btnCoupon");
const btnAvis   = document.getElementById("btnAvis");

btnCoupon.innerHTML = icons.btnCoupon;
btnAvis.innerHTML   = icons.btnAvis;

/* ‚úÖ Avis : universel vers avis.html */
btnAvis.href = `/${restoSlug}/avis.html`;

/* ===========
   INSTALL FLOW
   =========== */
let deferredPrompt = null;

// Android/Chrome : capture le prompt install natif
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
});

// Overlay UI
const overlay = document.getElementById("installOverlay");
const closeOverlayBtn = document.getElementById("closeOverlay");
const btnInstallNow = document.getElementById("btnInstallNow");
const btnContinueAnyway = document.getElementById("btnContinueAnyway");
const iosHelp = document.getElementById("iosHelp");

let nextAfterInstall = "coupon"; // "coupon" ou "inscription"
function openOverlay(next){
  nextAfterInstall = next || "coupon";
  overlay.style.display = "flex";
  iosHelp.style.display = (isIOS() ? "block" : "none");

  // Texte bouton selon contexte
  if (deferredPrompt) {
    btnInstallNow.textContent = "Installer maintenant";
  } else {
    // iOS ou navigateur sans BIP
    btnInstallNow.textContent = isIOS() ? "Voir comment installer" : "Installer l‚Äôapp";
  }
}
function closeOverlay(){
  overlay.style.display = "none";
}

closeOverlayBtn.addEventListener("click", closeOverlay);
overlay.addEventListener("click", (e) => {
  if (e.target === overlay) closeOverlay();
});

// Bouton install
btnInstallNow.addEventListener("click", async () => {
  // Android/Chrome (prompt natif)
  if (deferredPrompt) {
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;

    // On laisse 600ms puis on tente d'avancer (si l‚Äôutilisateur a install√©)
    setTimeout(() => {
      closeOverlay();
      routeAfterInstall();
    }, 600);
    return;
  }

  // iOS : pas de prompt natif => on affiche l‚Äôaide (d√©j√† visible)
  iosHelp.style.display = "block";
});

// Continuer vers inscription (m√™me sans install)
btnContinueAnyway.addEventListener("click", () => {
  closeOverlay();
  // on envoie direct vers inscription
  window.location.href = `/${restoSlug}/inscription.html?next=coupon`;
});

function routeAfterInstall(){
  const hasEmail = !!localStorage.getItem("user_email");

  if (nextAfterInstall === "coupon") {
    // Si pas encore en standalone, on ne force pas : l‚Äôutilisateur peut installer puis revenir
    if (!isStandalone()) return;

    if (!hasEmail) {
      window.location.href = `/${restoSlug}/inscription.html?next=coupon`;
      return;
    }
    window.location.href = `/${restoSlug}/coupon.html`;
  } else {
    window.location.href = `/${restoSlug}/inscription.html?next=coupon`;
  }
}

/* ===========
   COUPON GATING (INLINE, 1 √©cran)
   =========== */
btnCoupon.href = "javascript:void(0)";
btnCoupon.addEventListener("click", () => {
  const hasEmail = !!localStorage.getItem("user_email");

  // 1) Pas install√© => overlay (1 seul √©cran, pas de page)
  if (!isStandalone()) {
    openOverlay("coupon");
    return;
  }

  // 2) Install√©e mais pas identifi√© => inscription
  if (!hasEmail) {
    window.location.href = `/${restoSlug}/inscription.html?next=coupon`;
    return;
  }

  // 3) OK => coupon
  window.location.href = `/${restoSlug}/coupon.html`;
});
</script>

</body>
</html>
